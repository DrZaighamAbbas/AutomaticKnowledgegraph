"use strict";angular.module("wikiDiverApp",["ngAnimate","ngTagsInput"]),angular.module("wikiDiverApp").controller("AltCtrl",["$scope","$http","$log","$timeout","$interval","$window",function(a,b,c,d,e,f){function g(b,c){var d=(a.getAllLinks?"ALL-":"")+b;c=c||[],a.cacheLinks[d]=c,a.cacheLinksEmpty=!1;try{localStorage.setItem("seeAlsology-"+d,c.join("|")),localStorage.setItem("seeAlsology-update-"+d,Math.floor(new Date/1e3))}catch(e){}}function h(){a.getParents&&a.depth>2?a.alert="collecting parent links when crawling at a high depth can take a very long time":a.alert=!1}function i(a){return decodeURIComponent(a).replace(/_/g," ")}function j(a){return encodeURIComponent(a.replace(/ /g,"_"))}function k(b){return"https://"+a.lang+".wikipedia.org/wiki/"+j(b)}function l(a){return'<a class="discreet" target="_blank" href="'+k(a)+'">'+a+"</a>"}function m(b){return b.map(function(a){return a.replace(/#.*$/,"")}).filter(function(b){return a.stopWords.some(function(a){return-1!==b.toLowerCase().indexOf(a.text.toLowerCase())})?(-1===a.stoppedPages.indexOf(b)&&(a.stoppedPages.push(b),$(".stopped ul").append("<li>"+l(b)+"</li>")),!1):!!b.trim()})}function n(b,c){g(b,["#NOT-FOUND#"]);var d=i(b);-1===a.notFound.indexOf(d)&&c&&(a.notFound.push(d),$(".notFound ul").append("<li>"+l(d)+"</li>")),c?a.resolved++:a.parentsPending&&a.parentsPending--,a.running&&a.running--}function o(e,f,h,i,j,k){void 0===k&&(k=3),f&&(i?a.pending++:a.parentsPending++),b.jsonp("//"+a.lang+".wikipedia.org/w/api.php?format=json&action=query&prop=revisions&titles="+h+"&rvprop=content&rvsection="+e.index+"&redirects&callback=JSON_CALLBACK").success(function(a){if(!a.query)return n(h,i);for(var b=a.query.pages[Object.keys(a.query.pages)[0]].revisions[0]["*"],c=/\[\[(.*?)\]\]/g,e=c.exec(b),f=[];e;)f.push(e[1].split("|")[0]),e=c.exec(b);g(h,f),d(function(){j(m(f))},10)}).error(function(a,b,g,l){0==k?(c.error("Could not get content of SeeAlso section from API for",h,"with status",b,l.url,a,g,l),n(h,i)):d(function(){o(e,f,h,i,j,k-1)},250)})}function p(e,f,g,h){void 0===h&&(h=3);var i=(a.getAllLinks?"ALL-":"")+e;a.cacheLinks[i]?"#NOT-FOUND#"===a.cacheLinks[i][0]?n(e,g):d(function(){f(m(a.cacheLinks[i]))},10):b.jsonp("//"+a.lang+".wikipedia.org/w/api.php?action=parse&page="+e+"&prop=sections&format=json&redirects&callback=JSON_CALLBACK").success(function(b){if(!b.parse)return n(e,g);var c=b.parse.sections.filter(function(b){return-1!==y[a.lang].seeAlso.map(function(a){return a.toLowerCase()}).indexOf(b.line.toLowerCase())});return c.length?void c.forEach(function(a,b){o(a,b,e,g,f)}):n(e,g)}).error(function(a,b,i,j){0==h?(c.error("Could not get sections from API for",e,"with status",b,j.url,a,i,j),n(e,g)):d(function(){p(e,f,g,h-1)},250)})}function q(e,f,h,i){void 0===i&&(i=3);var j=a.cacheLinks["ALL-"+e];j?"#NOT-FOUND#"===j[0]?n(e,h):d(function(){f(m(j))},10):b.jsonp("//"+a.lang+".wikipedia.org/w/api.php?action=parse&page="+e+"&prop=links&format=json&redirects&callback=JSON_CALLBACK").success(function(a){if(!a.parse)return n(e,h);var b=a.parse.links.map(function(a){return a["*"]});return b.length?(g(e,b),void d(function(){f(m(b))},10)):n(e,h)}).error(function(a,b,g,j){0==i?(c.error("Could not get links from API for",e,"with status",b,j.url),n(e,h)):d(function(){q(e,f,h,i-1)},250)})}function r(b,c,d,e){var f=b.toLowerCase();e&&(e=e.toLowerCase());var g=a.network.hasNode(f),h=a.network.hasNode(e),i=g&&a.network.getNodeAttribute(f,"seed")||!!d;if(g)a.network.setNodeAttribute(f,"level",Math.min(c,a.network.getNodeAttribute(f,"level"))),a.network.setNodeAttribute(f,"seed",i),a.network.setNodeAttribute(f,"color",a.colors[i?0:a.network.getNodeAttribute(f,"level")+2]);else{var j,k,l;if(a.sigma){var m=a.sigma.nodeExtent.x[0],n=a.sigma.nodeExtent.x[1],o=a.sigma.nodeExtent.y[0],p=a.sigma.nodeExtent.y[1],q=n-m||1,r=p-o||1,s=Math.max(q,r);h&&a.network.order>2?(j=a.network.getNodeAttribute(e,"x"),k=a.network.getNodeAttribute(e,"y"),l=.1):(j=m+q/2,k=o+r/2,l=d?.1:.75),j+=(Math.random()-.5)*s*l,k+=(Math.random()-.5)*s*l}else j=Math.random(),k=Math.random();a.network.addNode(f,{label:b,x:j,y:k,size:1,level:c,seed:!!d,color:a.colors[d?0:c+2]})}1e3==a.network.order&&a.startLayout()}function s(b,c,d){r(b,d-1,!1,c),r(c,d,!1,b);var e=b.toLowerCase(),f=c.toLowerCase(),g=e+"->"+f;e===f||a.edgesIndex[g]||($("#edges").append("<tr><td>"+l(b)+"</td><td>"+l(c)+"</td><td>"+d+"</td></tr>"),a.edgesIndex[g]=!0,a.network.addEdgeWithKey(g,e,f,{index:d,color:"#ccc"}),a.network.setNodeAttribute(e,"size",Math.min(3,Math.sqrt(a.network.degree(e)))),a.network.setNodeAttribute(f,"size",Math.min(3,Math.sqrt(a.network.degree(f)))))}function t(){a.edgesQueue.length&&(a.edgesQueue.forEach(function(a){s(a.source,a.target,a.level)}),a.edgesQueue=[])}function u(b,c,e){if(!a.stopped){a.pending++;var f="",g=/wiki\/(.+?)(?:#.*)?$/g;e?(f=g.exec(b)[1],r(i(f),0,e)):f=j(b),a.queue.unshift({method:v,type:"sons",args:[f,c]}),a.getParents&&d(function(){w(f,c,e)},10)}}function v(b,c){(a.getAllLinks?q:p)(b,function(d){d.forEach(function(d){a.edgesQueue.push({source:i(b),target:~d.indexOf("_")?i(d):d,level:c+1}),c+1<a.depth&&u(d,c+1)}),a.resolved++,a.running&&a.running--},!0)}function w(d,e,f){a.doneParents[d]||(a.doneParents[d]=!0,b.jsonp("//"+a.lang+".wikipedia.org/w/api.php?action=query&bltitle="+d+"&blnamespace=0&list=backlinks&blredirect&blfilterredir=nonredirects&bllimit=250&format=json&callback=JSON_CALLBACK").success(function(b){b.query&&b.query.backlinks&&m(b.query.backlinks.map(function(a){return a.title})).forEach(function(b){if(!a.stopped){var c=j(b);a.parentsPending++;var g=(a.getAllLinks?"ALL-":"")+c;a.cacheLinks[g]?("#NOT-FOUND#"!==a.cacheLinks[g][0]&&x(d,c,e,a.cacheLinks[g]),a.parentsPending&&a.parentsPending--):a.queue[f?"unshift":"push"]({method:a.getAllLinks?q:p,type:"parent",args:[c,function(b){x(d,c,e,b),a.running&&a.running--,a.parentsPending&&a.parentsPending--}]})}})}).error(function(a,b,d,e){c.error("Could not get backlinks from API for","with status",b,e.url,a,d,e)}))}function x(b,c,d,e){var f=i(b),g=f.toLowerCase();e.some(function(a){return a.toLowerCase()===g})&&a.edgesQueue.push({source:i(c),target:f,level:d})}var y={en:{name:"english",seeAlso:["See also"],stopWords:["list of","index of","categories of","portal","disambiguation","outline of"]},fr:{name:"french",seeAlso:["Voir aussi","Articles connexes"],stopWords:["liste d","index d","catégories d","portail","désambiguïsation","résumé d","Catégorie:","Fichier:"]},es:{name:"spanish",seeAlso:["Véase también"],stopWords:["Ayuda:","Anexo:"]},it:{name:"italian",seeAlso:["Voci correlate","Vedi anche"],stopWords:["Portale:","Categoria:"]},de:{name:"german",seeAlso:["Siehe auch"],stopWords:["Liste von","Liste der","Portal","Begriffsklärung","Kategorie:","Diskussion:","Datei:"]},ta:{name:"tamil",seeAlso:["மேலும் பார்க்க","மேலும் பார்க்கவும்","மேலும் காண்க"],stopWords:["பட்டியல்","வலைவாசல்","பக்கவழிமாற்றுப் பக்கம்"]},et:{name:"estonian",seeAlso:["Vaata ka"],stopWords:["loend","täpsustus","Portaal:","Kategooria:","Arutelu:","Fail:"]},pt:{name:"portuguese",seeAlso:["Ver também"],stopWords:["lista d","Categoria:","Portal:","desambiguação","resumo d","File:"]},pl:{name:"polish",seeAlso:["Zobacz też"],stopWords:["przypisy","kategoria","dyskusja","linki zewnętrzne","pomoc"]},da:{name:"danish",seeAlso:["Se også"],stopWords:["liste af","Kategori:","Portal:","Fil:"]}};a.supportedLanguages=Object.keys(y).map(function(a){return y[a].name}).sort().join(", "),a.stopWords=["Wikipedia:","Category:","File:","Help:","Talk:","Template:","wikisource:","Commons:"],a.query="",a.depth=2,a.getParents=!1,a.getAllLinks=!1,a.maxQueries=5,a.cacheHours=24,a.network=void 0,a.layout=void 0,a.sigma=void 0,a.started=!1,a.colors=["#de2d26","#fc9272","#081d58","#253494","#225ea8","#1d91c0","#41b6c4","#7fcdbb","#c7e9b4","#edf8b1","#ffffd9"],a.example="https://en.wikipedia.org/wiki/Data_visualization\nhttps://en.wikipedia.org/wiki/Digital_humanities",a.setExample=function(){a.query=a.example,a.depth=3,a.getParents=!1},a.osSpecialClick=~f.navigator.userAgent.toLowerCase().search(/\bmac\s*os/i)?"Cmd":"Ctrl",a.init=function(){$("#edges, .stopped ul, .notFound ul, #warning").empty(),a.lang="",a.alert=!1,a.stopped=!1,a.notFound=[],a.stoppedPages=[],a.parentsPending=0,a.pending=0,a.resolved=0,a.queue=[],a.edgesQueue=[],a.running=0},a.init(),a.cacheLinks={};var z=Math.floor(new Date/1e3)-3600*a.cacheHours;try{Object.keys(localStorage).forEach(function(b){if(0===b.indexOf("seeAlsology-update-")){var c=b.replace("seeAlsology-update-","seeAlsology-"),d=c.replace("seeAlsology-","");parseInt(localStorage.getItem(b))<z?(localStorage.removeItem(b),localStorage.removeItem(c)):a.cacheLinks[d]=localStorage.getItem(c).split("|")}})}catch(A){}a.cacheLinksEmpty=!Object.keys(a.cacheLinks).length,a.clearCache=function(){Object.keys(localStorage).forEach(function(a){localStorage.removeItem(a)}),a.cacheLinks={},a.cacheLinksEmpty=!0},a.toggleParents=function(){a.working()||(a.getParents=!a.getParents)},a.toggleAllLinks=function(){a.working()||(a.getAllLinks=!a.getAllLinks)},a.startCrawl=function(){c.debug("starting crawling for",a.query.split("\n").length,"pages"),a.init(),a.started=!0,a.doneParents={},a.edgesIndex={},a.validate()&&(a.stopLayout(),a.sigma&&a.sigma.kill(),a.network=new Graph({type:"directed",allowSelfLoops:!1}),d(function(){a.initSigma(),f.scrollTo(0,document.getElementById("crawl-button").offsetTop-12)},750),d(function(){a.validPages.forEach(function(a){u(a,0,!0)})},200))},a.stopLayout=function(){a.layout&&a.layout.kill()},a.startLayout=function(){a.stopLayout(),a.layout=new ForceAtlas2Layout(a.network,{settings:{barnesHutOptimize:a.network.order>=1e3,strongGravityMode:!0,gravity:.1,scalingRatio:10,slowDown:15}}).start()},a.zoomIn=function(){},a.zoomOut=function(){},a.resetCamera=function(){},a.$on("$destroy",function(){a.layout.kill()}),a.initSigma=function(){var b=document.getElementById("sigma");b&&(a.sigma=new Sigma.WebGLRenderer(a.network,b),a.zoomIn=function(){var b=a.sigma.getCamera();b.animatedZoom()},a.zoomOut=function(){var b=a.sigma.getCamera();b.animatedUnzoom()},a.resetCamera=function(){var b=a.sigma.getCamera();b.animate({ratio:1,x:.5,y:.5})},a.sigma.on("clickNode",function(b,c,e,g,h){console.log("CLICK",b),d(function(){var c=k(a.network.getNodeAttribute(b.node,"label"));if(!b.captor.ctrlKey&&!b.captor.metaKey)return f.open(c,"_blank");if(!a.network.getNodeAttribute(b.node,"seed")){var c=k(a.network.getNodeAttribute(b.node,"label"));a.query+="\n"+c,a.network.setNodeAttribute(b.node,"seed",!0),a.network.setNodeAttribute(b.node,"color",a.colors[0]),a.stopped=!1,u(c,0,!0)}},10)}),$(".sigma-legend").empty(),a.colors.slice(0,a.depth+3).forEach(function(a,b){$(".sigma-legend").append('<span><div style="background-color: '+a+'"></div>&nbsp;&nbsp;'+(b?"level "+(b-2):"seeds")+"</span>")}),d(function(){a.startLayout(!0)},250))},a.validate=function(){if(a.alert&&0!==a.alert.indexOf("collecting")&&(a.alert=!1),a.missingLang=!1,!a.query.trim())return h(),a.alert||(a.alert="please enter at least one wikipedia page"),!1;var b=/https?:\/\/([a-z]+)\.wikipedia\.org\/wiki\/.+/i,c=null,d=a.query.split("\n"),e="",f=[],g=[];if(a.validPages=d.filter(function(a){return a.trim()?(c=a.match(b))?(e=c[1].toLowerCase(),-1===f.indexOf(e)&&f.push(e),!0):(g.push(a),!1):!1}),g.length)a.alert="these are not valid wikipedia pages: "+g.join(" &nbsp;&nbsp;&nbsp; ");else if(f.length>1)a.alert="please enter wikipedia pages from the same language (you gave pages from "+f.join(", ")+")";else{if(y[e]){h(),a.lang=f[0];var i=a.stopWords.map(function(a){return a.text});return y[e].stopWords.forEach(function(b){-1===i.indexOf(b)&&a.stopWords.push({text:b})}),!0}a.missingLang=!0,a.alert=e+' language is not supported yet, we do not know which section to look for as a "See also", neither which default stop-words to apply.'}return!1},a.$watchCollection("query",function(b,c){b!==c&&a.validate()}),a.$watchCollection("[getParents, depth]",function(b,c){b===c||a.alert&&0!==a.alert.indexOf("collecting")||h()}),a.downloadJSON=function(){var b=angular.toJson(a.network["export"]()),c=new Blob([b],{type:"data:text/json;charset=utf-8"});saveAs(c,"seealsology-data.json")},a.downloadCSV=function(){var b="source	target	depth\n";a.network.forEachEdge(function(a,c,d,e){b+=d+"	"+e+"	"+c.index+"\n"});var c=new Blob([b],{type:"data:text/csv;charset=utf-8"});saveAs(c,"seealsology-data.tsv")},a.downloadGEXF=function(){if(a.network){var b=new Blob([gexf.write(a.network,{formatNode:function(a,b){return{label:b.label,attributes:["level","seed"],viz:{color:b.color,size:b.size,x:b.x,y:b.y}}}})],{type:"text/gexf+xml;charset=utf-8"});saveAs(b,"seealsology-data.gexf",!0)}},e(function(){for(t();!a.stopped&&a.queue.length>0&&a.running<a.maxQueries;){var b=a.queue.shift();a.running++,b.method.apply(null,b.args)}},100),a.clearQueue=function(){a.stopped=!0,a.queue.forEach(function(b){"sons"===b.type?a.pending--:a.parentsPending&&a.parentsPending--}),a.queue=[]},a.working=function(){return a.queue.length+a.running+a.parentsPending+a.pending-a.resolved+a.edgesQueue.length},a.$watch(a.working,function(b,c){b||b===c||d(function(){!a.working()&&a.layout&&(Object.keys(a.edgesIndex).length||$("#warning").append('<div class="col-md-12"><div class="alert alert-danger">Warning: no result found from these seeds.</div></div>'),a.startLayout(),d(a.stopLayout,2500+parseInt(200*Math.sqrt(10*a.network.order))),a.stopped=!1)},500)})}]);