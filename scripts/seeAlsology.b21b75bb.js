"use strict";angular.module("wikiDiverApp",["ngAnimate","ngTagsInput"]),angular.module("wikiDiverApp").controller("AltCtrl",["$scope","$http","$log","$timeout","$interval","$window",function(a,b,c,d,e,f){function g(b,c){c=c||[],a.cacheLinks[b]=c,a.cacheLinksEmpty=!1;try{localStorage.setItem("seeAlsology-"+b,c.join("|")),localStorage.setItem("seeAlsology-update-"+b,Math.floor(new Date/1e3))}catch(d){}}function h(){a.getParents&&a.depth>2?a.alert="collecting parent links when crawling at a high depth can take a very long time":a.alert=!1}function i(a){return decodeURIComponent(a).replace(/_/g," ")}function j(a){return encodeURIComponent(a.replace(/ /g,"_"))}function k(b){return"http://"+a.lang+".wikipedia.org/wiki/"+j(b)}function l(a){return'<a class="discreet" target="_blank" href="'+k(a)+'">'+a+"</a>"}function m(b){return b.map(function(a){return a.replace(/#.*$/,"")}).filter(function(b){return a.stopWords.some(function(a){return-1!==b.toLowerCase().indexOf(a.text.toLowerCase())})?(-1===a.stoppedPages.indexOf(b)&&(a.stoppedPages.push(b),$(".stopped ul").append("<li>"+l(b)+"</li>")),!1):!!b.trim()})}function n(b,c){g(b,["#NOT-FOUND#"]);var d=i(b);-1===a.notFound.indexOf(d)&&c&&(a.notFound.push(d),$(".notFound ul").append("<li>"+l(d)+"</li>")),c?a.resolved++:a.parentsPending&&a.parentsPending--,a.running&&a.running--}function o(d,e,f){a.cacheLinks[d]?"#NOT-FOUND#"===a.cacheLinks[d][0]?n(d,f):e(m(a.cacheLinks[d])):b.jsonp("http://"+a.lang+".wikipedia.org/w/api.php?action=parse&page="+d+"&prop=sections&format=json&redirects&callback=JSON_CALLBACK").success(function(h){if(!h.parse)return n(d,f);var i=h.parse.sections.filter(function(b){return-1!==w[a.lang].seeAlso.map(function(a){return a.toLowerCase()}).indexOf(b.line.toLowerCase())});return i.length?void i.forEach(function(h,i){i&&(f?a.pending++:a.parentsPending++),b.jsonp("http://"+a.lang+".wikipedia.org/w/api.php?format=json&action=query&prop=revisions&titles="+d+"&rvprop=content&rvsection="+h.index+"&redirects&callback=JSON_CALLBACK").success(function(a){if(!a.query)return n(d,f);for(var b=a.query.pages[Object.keys(a.query.pages)[0]].revisions[0]["*"],c=/\[\[(.*?)\]\]/g,h=c.exec(b),i=[];h;)i.push(h[1].split("|")[0]),h=c.exec(b);g(d,i),e(m(i))}).error(function(a){c.error("Could not get content of SeeAlso section from API for",d,a),n(d,f)})}):n(d,f)}).error(function(a){c.error("Could not get sections from API for",d,a),n(d,f)})}function p(b,c,d){var e=b.toLowerCase(),f=a.sigma.graph.nodes(e);f?(f.level=Math.min(c,f.level),f.seed=f.seed||!!d,f.color=a.colors[f.seed?0:f.level+2]):a.sigma.graph.addNode({id:e,label:b,x:Math.random(),y:Math.random(),size:1,level:c,seed:!!d,color:a.colors[d?0:c+2]})}function q(b,c,d){p(b,d-1),p(c,d);var e=b.toLowerCase(),f=c.toLowerCase(),g=e+"->"+f;a.edgesIndex[g]||($("#edges").append("<tr><td>"+l(b)+"</td><td>"+l(c)+"</td><td>"+d+"</td></tr>"),a.edgesIndex[g]=!0,a.sigma.graph.addEdge({id:g,source:e,target:f,index:d,color:"#ccc"}),a.sigma.graph.nodes(e).size=a.sigma.graph.degree(e),a.sigma.graph.nodes(f).size=a.sigma.graph.degree(f))}function r(){a.edgesQueue.length&&(a.sigma.killForceAtlas2(),a.edgesQueue.forEach(function(a){q(a.source,a.target,a.level)}),a.edgesQueue=[],a.sigma.startForceAtlas2())}function s(b,c,e){if(!a.stopped){a.pending++;var f="",g=/wiki\/(.+?)(?:#.*)?$/g;e?(f=g.exec(b)[1],p(i(f),0,e)):f=j(b),a.queue.unshift({method:t,type:"sons",args:[f,c]}),a.getParents&&d(function(){u(f,c,e)},10)}}function t(b,c){o(b,function(d){d.forEach(function(d){a.edgesQueue.push({source:i(b),target:~d.indexOf("_")?i(d):d,level:c+1}),c+1<a.depth&&s(d,c+1)}),a.resolved++,a.running&&a.running--},!0)}function u(d,e,f){a.doneParents[d]||(a.doneParents[d]=!0,b.jsonp("http://"+a.lang+".wikipedia.org/w/api.php?action=query&bltitle="+d+"&blnamespace=0&list=backlinks&blredirect&blfilterredir=nonredirects&bllimit=250&format=json&callback=JSON_CALLBACK").success(function(b){b.query&&b.query.backlinks&&m(b.query.backlinks.map(function(a){return a.title})).forEach(function(b){if(!a.stopped){var c=j(b);a.parentsPending++,a.cacheLinks[c]?("#NOT-FOUND#"!==a.cacheLinks[c][0]&&v(d,c,e,a.cacheLinks[c]),a.parentsPending&&a.parentsPending--):a.queue[f?"unshift":"push"]({method:o,type:"parent",args:[c,function(b){v(d,c,e,b),a.running&&a.running--,a.parentsPending&&a.parentsPending--}]})}})}).error(function(a){c.error("Could not get backlinks from API for",d,a)}))}function v(b,c,d,e){var f=i(b),g=f.toLowerCase();e.some(function(a){return a.toLowerCase()===g})&&a.edgesQueue.push({source:i(c),target:f,level:d})}var w={en:{name:"english",seeAlso:["See also"],stopWords:["list of","index of","categories of","portal","disambiguation","outline of"]},fr:{name:"french",seeAlso:["Voir aussi","Articles connexes"],stopWords:["liste d","index d","catégories d","portail","désambiguïsation","résumé d","Catégorie:","Fichier:"]},es:{name:"spanish",seeAlso:["Véase también"],stopWords:["Ayuda:","Anexo:"]},it:{name:"italian",seeAlso:["Voci correlate","Vedi anche"],stopWords:["Portale:","Categoria:"]},de:{name:"german",seeAlso:["Siehe auch"],stopWords:["Liste von","Liste der","Portal","Begriffsklärung","Kategorie:","Diskussion:","Datei:"]},ta:{name:"tamil",seeAlso:["மேலும் பார்க்க","மேலும் பார்க்கவும்","மேலும் காண்க"],stopWords:["பட்டியல்","வலைவாசல்","பக்கவழிமாற்றுப் பக்கம்"]},et:{name:"estonian",seeAlso:["Vaata ka"],stopWords:["loend","täpsustus","Portaal:","Kategooria:","Arutelu:","Fail:"]},pt:{name:"portuguese",seeAlso:["Ver também"],stopWords:["lista d","Categoria:","Portal:","desambiguação","resumo d","File:"]}};a.supportedLanguages=Object.keys(w).map(function(a){return w[a].name}).join(", "),a.stopWords=["Wikipedia:","Category:","File:","wikisource:","Commons:"],a.query="",a.depth=2,a.getParents=!0,a.maxQueries=10,a.cacheHours=24,a.sigma=void 0,a.colors=["#de2d26","#fc9272","#081d58","#253494","#225ea8","#1d91c0","#41b6c4","#7fcdbb","#c7e9b4","#edf8b1","#ffffd9"],a.example="http://en.wikipedia.org/wiki/Data_visualization\nhttp://en.wikipedia.org/wiki/Digital_humanities",a.setExample=function(){a.query=a.example,a.depth=3,a.getParents=!1},a.osSpecialClick=~f.navigator.userAgent.toLowerCase().search(/\bmac\s*os/i)?"Cmd":"Ctrl",a.init=function(){$("#edges, .stopped ul, .notFound ul, #warning").empty(),a.lang="",a.alert=!1,a.stopped=!1,a.notFound=[],a.stoppedPages=[],a.parentsPending=0,a.pending=0,a.resolved=0,a.queue=[],a.edgesQueue=[],a.running=0},a.init(),a.cacheLinks={};var x=Math.floor(new Date/1e3)-3600*a.cacheHours;try{Object.keys(localStorage).forEach(function(b){if(0===b.indexOf("seeAlsology-update-")){var c=b.replace("seeAlsology-update-","seeAlsology-"),d=c.replace("seeAlsology-","");parseInt(localStorage.getItem(b))<x?(localStorage.removeItem(b),localStorage.removeItem(c)):a.cacheLinks[d]=localStorage.getItem(c).split("|")}})}catch(y){}a.cacheLinksEmpty=!Object.keys(a.cacheLinks).length,a.clearCache=function(){Object.keys(localStorage).forEach(function(a){localStorage.removeItem(a)}),a.cacheLinks={},a.cacheLinksEmpty=!0},a.toggleParents=function(){a.getParents=!a.getParents},a.startCrawl=function(){c.debug("starting crawling for",a.query.split("\n").length,"pages"),a.init(),a.doneParents={},a.edgesIndex={},a.sigma&&a.sigma.kill(),a.sigma=new sigma({container:"sigma",settings:{labelThreshold:5,singleHover:!0,minNodeSize:2}}).configForceAtlas2({adjustSizes:!0,scalingRatio:10,strongGravityMode:!0,gravity:.1,slowDown:15}),$(".sigma-legend").empty(),a.colors.slice(0,a.depth+3).forEach(function(a,b){$(".sigma-legend").append('<span><div style="background-color: '+a+'"></div>&nbsp;&nbsp;'+(b?"level "+(b-2):"seeds")+"</span>")}),a.sigma.bind("clickNode",function(b){var c=k(b.data.node.label);return b.data.captor.ctrlKey||b.data.captor.metaKey?void(b.data.node.seed||(a.query+="\n"+c,b.data.node.seed=!0,b.data.node.color=a.colors[0],a.sigma.refresh(),d(function(){a.stopped=!1,s(c,0,!0)},10))):f.open(c,"_blank")}),a.validate()&&(d(function(){f.scrollTo(0,document.getElementById("crawl-button").offsetTop-12)},250),d(function(){a.validPages.forEach(function(a){s(a,0,!0)})},10))},a.validate=function(){if(a.alert&&0!==a.alert.indexOf("collecting")&&(a.alert=!1),a.missingLang=!1,!a.query.trim())return h(),a.alert||(a.alert="please enter at least one wikipedia page"),!1;var b=/https?:\/\/([a-z]+)\.wikipedia\.org\/wiki\/.+/i,c=null,d=a.query.split("\n"),e="",f=[],g=[];if(a.validPages=d.filter(function(a){return a.trim()?(c=a.match(b))?(e=c[1].toLowerCase(),-1===f.indexOf(e)&&f.push(e),!0):(g.push(a),!1):!1}),g.length)a.alert="these are not valid wikipedia pages: "+g.join(" &nbsp;&nbsp;&nbsp; ");else if(f.length>1)a.alert="please enter wikipedia pages from the same language (you gave pages from "+f.join(", ")+")";else{if(w[e]){h(),a.lang=f[0];var i=a.stopWords.map(function(a){return a.text});return w[e].stopWords.forEach(function(b){-1===i.indexOf(b)&&a.stopWords.push({text:b})}),!0}a.missingLang=!0,a.alert=e+' language is not supported yet, we do not know which section to look for as a "See also", neither which default stop-words to apply.'}return!1},a.$watchCollection("query",function(b,c){b!==c&&a.validate()}),a.$watchCollection("[getParents, depth]",function(b,c){b===c||a.alert&&0!==a.alert.indexOf("collecting")||h()}),a.downloadJSON=function(){var b=angular.toJson({nodes:a.sigma.graph.nodes(),edges:a.sigma.graph.edges()}),c=new Blob([b],{type:"data:text/json;charset=utf-8"});saveAs(c,"seealsology-data.json")},a.downloadCSV=function(){var b="source	target	depth\n";a.sigma.graph.edges().forEach(function(a){b+=a.source+"	"+a.target+"	"+a.index+"\n"});var c=new Blob([b],{type:"data:text/csv;charset=utf-8"});saveAs(c,"seealsology-data.tsv")},a.downloadGEXF=function(){var b=gexf.create({defaultEdgeType:"directed"});b.addNodeAttribute({id:"level",title:"Level",type:"integer"}),b.addNodeAttribute({id:"seed",title:"Seed",type:"boolean"}),a.sigma.graph.nodes().forEach(function(c){b.addNode({id:c.id,label:c.label,attributes:{level:c.level,seed:c.seed},viz:{color:c.color,size:a.sigma.graph.degree(c.label),position:{x:c["read_cam0:x"],y:-c["read_cam0:y"]}}})}),a.sigma.graph.edges().forEach(function(a){b.addEdge({source:a.source,target:a.target})});var c=new Blob([b.serialize()],{type:"data:application/xml+gexf;charset=utf-8"});saveAs(c,"seealsology-data.gexf")},e(function(){for(r();!a.stopped&&a.queue.length>0&&a.running<a.maxQueries;){var b=a.queue.shift();a.running++,b.method.apply(null,b.args)}},200),a.clearQueue=function(){a.stopped=!0,a.queue.forEach(function(b){"sons"===b.type?a.pending--:a.parentsPending&&a.parentsPending--}),a.queue=[]},a.working=function(){return a.queue.length+a.running+a.parentsPending+a.pending-a.resolved+a.edgesQueue.length},a.$watch(a.working,function(b,c){b||b===c||d(function(){!a.working()&&a.sigma&&(Object.keys(a.edgesIndex).length||$("#warning").append('<div class="col-md-12"><div class="alert alert-danger">Warning: no result found from these seeds.</div></div>'),a.sigma.stopForceAtlas2(),a.stopped=!1)},1500+parseInt(200*Math.sqrt(10*a.sigma.graph.nodes().length)))}),a.zoomSigma=function(b){var c=a.sigma.cameras[0];sigma.misc.animation.camera(c,{ratio:c.ratio*(b?1/1.5:1.5)},{duration:150})},a.recenterSigma=function(){sigma.misc.animation.camera(a.sigma.cameras[0],{x:0,y:0,angle:0,ratio:1},{duration:150})}}]);